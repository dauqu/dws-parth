<!DOCTYPE html>
<html>
<head>
    <title>Frontend WebSocket Test - Device Detail</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.3);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        h1 { margin-top: 0; text-align: center; }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 16px;
            font-weight: bold;
        }
        .connected { background: rgba(16, 185, 129, 0.3); border: 2px solid #10b981; }
        .disconnected { background: rgba(239, 68, 68, 0.3); border: 2px solid #ef4444; }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .metric-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .metric-title {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 10px;
        }
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #fff;
        }
        .metric-unit {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.6);
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .log {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 20px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 3px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .timestamp {
            color: #60a5fa;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñ•Ô∏è Device Detail - WebSocket Test</h1>
        
        <div id="connectionStatus" class="status disconnected">
            ‚ùå Disconnected
        </div>

        <div class="metrics">
            <div class="metric-card">
                <div class="metric-title">CPU Usage</div>
                <div class="metric-value" id="cpuValue">--</div>
                <div class="metric-unit">%</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="cpuBar" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-title">RAM Usage</div>
                <div class="metric-value" id="ramValue">--</div>
                <div class="metric-unit">%</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="ramBar" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-title">Disk Usage</div>
                <div class="metric-value" id="diskValue">--</div>
                <div class="metric-unit">%</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="diskBar" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-title">CPU Cores</div>
                <div class="metric-value" id="coresValue">--</div>
                <div class="metric-unit">cores</div>
            </div>
        </div>

        <div class="metric-card" style="margin-top: 20px;">
            <div class="metric-title">Device Info</div>
            <div id="deviceInfo" style="font-size: 14px; line-height: 1.8;">
                <div>Hostname: <span id="hostname">--</span></div>
                <div>Username: <span id="username">--</span></div>
                <div>IP Address: <span id="ipAddress">--</span></div>
                <div>OS: <span id="os">--</span></div>
                <div>Uptime: <span id="uptime">--</span></div>
            </div>
        </div>

        <h3 style="margin-top: 30px;">WebSocket Messages Log</h3>
        <div class="log" id="logContainer"></div>
    </div>

    <script>
        const DEVICE_ID = 'HarshaWeb';
        const WS_URL = 'ws://localhost:8080/ws/frontend';
        let ws = null;
        let messageCount = 0;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            const logContainer = document.getElementById('logContainer');
            logContainer.insertBefore(logEntry, logContainer.firstChild);
            console.log(`[${timestamp}] ${message}`);
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.textContent = '‚úÖ Connected to Device: ' + DEVICE_ID;
                statusEl.className = 'status connected';
            } else {
                statusEl.textContent = '‚ùå Disconnected';
                statusEl.className = 'status disconnected';
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (days > 0) return `${days}d ${hours}h`;
            if (hours > 0) return `${hours}h ${minutes}m`;
            return `${minutes}m`;
        }

        function updateMetrics(data) {
            // CPU
            if (data.cpu_usage !== undefined) {
                const cpuUsage = Math.round(data.cpu_usage);
                document.getElementById('cpuValue').textContent = cpuUsage;
                document.getElementById('cpuBar').style.width = cpuUsage + '%';
            }
            
            // RAM
            if (data.ram_percent !== undefined) {
                const ramUsage = Math.round(data.ram_percent);
                document.getElementById('ramValue').textContent = ramUsage;
                document.getElementById('ramBar').style.width = ramUsage + '%';
            }
            
            // Disk
            if (data.disk_percent !== undefined) {
                const diskUsage = Math.round(data.disk_percent);
                document.getElementById('diskValue').textContent = diskUsage;
                document.getElementById('diskBar').style.width = diskUsage + '%';
            }
            
            // CPU Cores
            if (data.cpu_cores !== undefined) {
                document.getElementById('coresValue').textContent = data.cpu_cores;
            }

            // Device Info
            if (data.hostname) document.getElementById('hostname').textContent = data.hostname;
            if (data.username) document.getElementById('username').textContent = data.username;
            if (data.ip_address) document.getElementById('ipAddress').textContent = data.ip_address;
            if (data.platform) document.getElementById('os').textContent = data.platform;
            if (data.uptime !== undefined) {
                document.getElementById('uptime').textContent = formatUptime(data.uptime);
            }

            log(`üìä Metrics updated: CPU ${Math.round(data.cpu_usage)}%, RAM ${Math.round(data.ram_percent)}%`);
        }

        function connectWebSocket() {
            log('üîå Connecting to ' + WS_URL);
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                log('‚úÖ WebSocket connected');
                updateConnectionStatus(true);
            };

            ws.onmessage = (event) => {
                try {
                    messageCount++;
                    const message = JSON.parse(event.data);
                    
                    log(`üì® Message #${messageCount}: type=${message.type}, device_id=${message.device_id || 'N/A'}`);
                    
                    // Only process messages for our device
                    if (message.type === 'system_update' && message.device_id === DEVICE_ID) {
                        log(`‚úÖ System update for ${DEVICE_ID}`);
                        updateMetrics(message.data);
                    } else if (message.type === 'device_list') {
                        log(`üìã Device list received: ${JSON.stringify(message.data).substring(0, 100)}...`);
                    } else {
                        log(`‚ÑπÔ∏è Other message type: ${message.type}`);
                    }
                } catch (error) {
                    log(`‚ùå Error parsing message: ${error.message}`);
                }
            };

            ws.onerror = (error) => {
                log('‚ùå WebSocket error: ' + error);
                updateConnectionStatus(false);
            };

            ws.onclose = () => {
                log('üîå WebSocket disconnected - reconnecting in 3s...');
                updateConnectionStatus(false);
                setTimeout(connectWebSocket, 3000);
            };
        }

        // Start connection
        connectWebSocket();
    </script>
</body>
</html>
